<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tech Inside | Painel de funcionários</title>
  <link rel="stylesheet" href="css/painelFuncionarios.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/funcoes.js"></script>
  <link rel="icon" type="image/x-icon" href="assets/trimmed-icon.png">

</head>

<body onload="listarUsuarios(),validarSessao()">
  <script>
    window.fwSettings={
    'widget_id':150000001098
    };
    !function(){if("function"!=typeof window.FreshworksWidget){var n=function(){n.q.push(arguments)};n.q=[],window.FreshworksWidget=n}}() 
  </script>
  <script type='text/javascript' class="btn-desk" src='https://widget.freshworks.com/widgets/150000001098.js' async defer></script>
  <div class="body">

    <div class="div_cover"></div>
    <div class="logo-mobile">
      <img src="assets/logo-versao1.png" alt="">
    </div>

    <div class="menu_lateral">
      <div class="container_logo">
        <img src="assets/trimmed-icon.png" />
      </div>

      <ul class="nav-lateral">
        <a href="dashboard.html">
          <li class="li-inicial">
            <img src="assets/icon-dash.png">
            <span>Página inicial</span>
          </li>
        </a>

        <a href="painelFuncionarios.html">
          <li class="li-col agora">
            <img src="assets/icon-cola.png">
            <span>Colaboradores</span>
          </li>
        </a>

        <a href="conta.html">
          <li class="li-conta">
            <img src="assets/icon-conta.png">
            <span>Minha conta</span>
          </li>
        </a>

        <a href="index.html">
          <li class="li-sair">
            <img src="assets/icon-logout.png">
            <span>Sair</span>
          </li>
        </a>
      </ul>

      <img src="assets/icon-logout.png" class="icon-logout" alt="sair">
      <button id="btn_sair" onclick="limparSessao()">Sair</button>

    </div>

    <div class="content">
      <div class="menu_top">
        <div>
          <h2>Colaboradores <span>/ Máquinas</span></h2>
          <p>Configurações
        </div>

        <div class="perfil">
          <img src="assets/profile_picture.jpg" />
          <div class="container_nome_cargo">
            <h3>
              <span id="nome_usuario">Nome</span>
              <span id="id_usuario"></span>
            </h3>
            <p id="cargo_usuario">Cargo</p>
          </div>
        </div>
      </div>

      <div class="uniao">
        <div class="container_filtros">
          <h2>Cadastrados:</h2>
        </div>
      </div>
      <button id="cadastrar_usuario" onclick="show()">
        Cadastrar funcionário
      </button>                     
      <div class="hidden_form" id="hidden_form" style="display: none;">
        <p onclick="hideDiv()">X</p>
        <h2 id="h2_form"></h2>
        <div class="ipt_form">
          Nome: <input type="text" id="ipt_nomeUsuario" placeholder="Nome">
          Cargo: <input type="text" id="ipt_cargoUsuario" placeholder="Cargo">
          Setor: <input type="text" id="ipt_setorUsuario" placeholder="Setor">
          CPF: <input type="text" id="ipt_cpfUsuario" placeholder="CPF">
          E-mail: <input type="text" id="ipt_emailUsuario" placeholder="E-mail">
          Senha: <input type="password" id="ipt_senhaUsuario" placeholder="Senha">
          <div class="div_checkbox">
            <input type="checkbox" id="chkAdmin">
            <label for="chkAdmin">Admin</label>
          </div>
        </div>
        <div id="cardErro">
          <span id="mensagem_erro"></span>
        </div>
        <div id="container_btns">

        </div>
      </div>



      <div id="hidden_confirmacao" class="hidden_confirmacao" style="display: none;"></div>

      <div id="hidden_maquina" class="hidden_maquina" style="display: none;">
        <div class="container_maquina">
        
        <p onclick="hideMaquina()">X</p>
        <h2>Cadastrar máquina</h2>
        <div class="form_maquina">

          <div class="left">
            Marca: <input type="text" id="ipt_marca_maquina">
            Modelo: <input type="text" id="ipt_modelo_maquina">
            Serial Number: <input type="text" id="ipt_serial_number_maquina">
          </div>

          <div class="right">

            <label for="chk_uso_cpu"><input type="checkbox" id="chk_uso_cpu"> Monitorar uso da CPU</label>
            <div class="containerChecked">
              <!-- <input type="text" placeholder="Total da CPU" class="input_right_maquina" id="input_right_totalCpu"> -->
              <input type="text" class="inputMaquinaChecked" id="triggerMaxUsoCpu" style="display: none;" placeholder="Trigger max">
              <input type="text" class="inputMaquinaChecked" id="triggerMinUsoCpu" style="display: none;" placeholder="Trigger min">

            </div>

            <label for="chk_uso_ram"><input type="checkbox" id="chk_uso_ram"> Monitorar uso da RAM</label>
            <div class="containerCheckedRAM">
              <input type="text" class="inputMaquinaChecked" id="input_right_totalRam" style="display: none;" placeholder="Total da RAM">
              <input type="text" class="inputMaquinaChecked" id="triggerMaxRam" style="display: none;" placeholder="Trigger max">
              <input type="text" class="inputMaquinaChecked" id="triggerMinRam" style="display: none;" placeholder="Trigger min">
            </div>

            <label for="chk_temperatura_cpu"><input type="checkbox" id="chk_temperatura_cpu"> Temperatura da CPU</label>
            <div class="containerChecked">
              <input type="text" class="inputMaquinaChecked" id="triggerMaxTempCpu" style="display: none" placeholder="Trigger max">
              <input type="text" class="inputMaquinaChecked" id="triggerMinTempCpu" style="display: none" placeholder="Trigger min">
            </div>

          </div>
        </div>

        <button id="btn_cadastrar_maquina" onclick="cadastrarMaquina()">Cadastrar</button>

      </div>

      </div>

      <div id="table_wrapper">
        <table style="width: 100%" id="table_func">
          <colgroup>
            <col style="width: 30%;" />
            <col style="width: 30%;" />
            <col style="width: 20%;" />
            <col style="width: 10%;" />
            <col style="width: 10%;" />
          </colgroup>
          <tbody id="exibirUsuarios">
            <tr class="header">
              <th>Nome</th>
              <th>Área</th>
              <th>Cargo</th>
              <th>Admin</th>
              <th style="text-align: center;">Gerenciar</th>
            </tr>
          </tbody>
      </div>
    </div>

    
  </div>

</body>

</html>

<script>

  var idEmpresa = sessionStorage.getItem('ID_EMPRESA')
  var idUsuario = sessionStorage.getItem('ID_USUARIO')
  var nomeEmpresa = sessionStorage.getItem('NOME_EMPRESA')
  var nomeUsuario = sessionStorage.getItem('NOME_USUARIO')
  var cargoUsuario = sessionStorage.getItem('CARGO_USUARIO')

  if (nomeEmpresa != null) {
    nome_usuario.innerHTML = nomeEmpresa.toLocaleUpperCase(); // esta formatado para a primeira letra ser Maiuscula
    id_usuario.innerHTML = `(ID: ${idEmpresa})`;
    cargo_usuario.innerHTML = "EMPRESA";
  } else if (nomeUsuario != null) {
    nome_usuario.innerHTML = nomeUsuario[0].toLocaleUpperCase() + nomeUsuario.substr(1);
    id_usuario.style.display = "none";
    cargo_usuario.innerHTML = cargoUsuario[0].toLocaleUpperCase() + cargoUsuario.substr(1);
  }


  function listarUsuarios() {
    fetch(`/usuarios/listarUsuarios/${idEmpresa}`).then(function (resposta) {
      if (resposta.ok) {
        if (resposta.status == 204) {
          throw "Nenhum resultado encontrado!!";
        }
        resposta.json().then(function (resposta) {

          for (let i = 0; i < resposta.length; i++) {

            var publicacao = resposta[i]; // i é a posição 0
            console.log(publicacao);


            let nomeUsuario = publicacao.nomeUser
            let cargoUsuario = publicacao.cargoUser
            let idUsuarioLog = publicacao.idUsuario
            let isAdmin = (publicacao.userAdmin != null) ? '' : 'Sim'
            let areaUser = publicacao.setorUser

            if (idUsuario != idUsuarioLog) {
              exibirUsuarios.innerHTML += `
                              <tr>
                                <td>${nomeUsuario}</td>
                                <td>${areaUser}</td>
                                <td>${cargoUsuario}</td>
                                <td>${isAdmin}</td>
                                <td class="gerenciar">
                                  <img src="assets/lixeira.png" title="Deletar" onclick="popUpDeletar(${idUsuarioLog})">
                                  <img src="assets/gear.png" title="Gerenciar usuário" onclick="listarFuncionario(${idUsuarioLog})">
                                  <img src="assets/computer.png" title="Gerenciar máquina" onclick="showMaquina()">
                                </td>
                              </tr>
                              `
            }

          }
        })
      } else {
        throw ('Houve um erro na API!');
      }
    }).catch(function (resposta) {
      console.error(resposta);
    });
  }

  function deletarUsuario(idUsuarioLog) {
    let deletUsuarioVar = idUsuarioLog

    fetch(`/usuarios/deletar/${deletUsuarioVar}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json"
      }
    }).then(function (resposta) {

      if (resposta.ok) {
        window.location = "/painelFuncionarios.html"
      } else if (resposta.status == 404) {
        window.alert("Deu 404!");
      } else {
        throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });
  }

  function fecharPopUpDelet() {
    hidden_confirmacao.style.display = "none"
  }

  function popUpDeletar(idFuncionario) {
    var hidden_div = document.getElementById("hidden_confirmacao");
    hidden_div.style.display = "flex"

    hidden_div.innerHTML = `
    <h2>Tem certeza que deseja excluir o funcionário?</h2>
          <div class="botoes">
            <button id="confirma_delet" onclick="deletarUsuario(${idFuncionario})">Sim</button>
            <button id="cancela_delet" onclick="fecharPopUpDelet()">Não</button>
          </div>
          `


  }

  function show() {
    var hidden_div = document.getElementById("hidden_form")
    h2_form.innerHTML = "Cadastre um funcionário"
    hidden_div.style.display = "block"
    container_btns.innerHTML = `<button id="btn_cadastro" onclick="cadastroUsuario()">Cadastrar</button>`


    ipt_nomeUsuario.value = ""
    ipt_cargoUsuario.value = ""
    ipt_setorUsuario.value = ""
    ipt_cpfUsuario.value = ""
    ipt_emailUsuario.value = ""
    ipt_senhaUsuario.value = ""
    chkAdmin.checked = false

  }

  function hideDiv() {
    var hidden_div = document.getElementById("hidden_form")
    hidden_div.style.display = "none"
  }

  chk_uso_cpu.addEventListener("click", function(event){
    if(chk_uso_cpu.checked){
      triggerMaxUsoCpu.style.display = "block"
      triggerMinUsoCpu.style.display = "block"

    }else{
      triggerMaxUsoCpu.style.display = "none"
      triggerMinUsoCpu.style.display = "none"

    }
    })

    chk_uso_ram.addEventListener("click", function(event){
      if(chk_uso_ram.checked){
      input_right_totalRam.style.display = "block"
      triggerMaxRam.style.display = "block"
      triggerMinRam.style.display = "block"

    }else{
      input_right_totalRam.style.display = "none"
      triggerMaxRam.style.display = "none"
      triggerMinRam.style.display = "none"

    }
    })

    chk_temperatura_cpu.addEventListener("click", function(event){
      if(chk_temperatura_cpu.checked){
      triggerMaxTempCpu.style.display = "block"
      triggerMinTempCpu.style.display = "block"

    }else{
      triggerMaxTempCpu.style.display = "none"
      triggerMinTempCpu.style.display = "none"

    }
    })

  function showMaquina(idUsuario) {
    var hidden_div = document.getElementById("hidden_maquina")
    hidden_div.style.display = "block"
    container_maquina.innerHTML += `<button id="btn_cadastrar_maquina" onclick="cadastrarMaquina(${idUsuario})">Cadastrar</button>`

  }

  function hideMaquina() {
    var hidden_div = document.getElementById("hidden_maquina")
    hidden_div.style.display = "none"
  }

  function cadastroUsuario() {
    var nomeUsuarioVar = ipt_nomeUsuario.value;
    var cargoUsuarioVar = ipt_cargoUsuario.value;
    var setorUsuarioVar = ipt_setorUsuario.value;
    var emailUsuarioVar = ipt_emailUsuario.value;
    var senhaUsuarioVar = ipt_senhaUsuario.value;
    var cpfUsuarioVar = ipt_cpfUsuario.value;
    var fkEmpresaVar = sessionStorage.ID_EMPRESA;
    var fkUsuarioAdminVar = (document.getElementById("chkAdmin").checked) ? null : idUsuario

    if (
      nomeUsuarioVar == "" || cargoUsuarioVar == "" || setorUsuarioVar == "" || emailUsuarioVar == "" || senhaUsuarioVar == "" || cpfUsuarioVar == "" || fkUsuarioAdminVar == "" || fkEmpresaVar == ""
    ) {
      cardErro.style.display = "block"
      mensagem_erro.innerHTML = "Existem dados em branco"

    }else {

      fetch("/usuarios/cadastroUsuario", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          nomeUsuarioServer: nomeUsuarioVar,
          cargoUsuarioServer: cargoUsuarioVar,
          setorUsuarioServer: setorUsuarioVar,
          emailUsuarioServer: emailUsuarioVar,
          senhaUsuarioServer: senhaUsuarioVar,
          cpfUsuarioServer: cpfUsuarioVar,
          fkUsuarioAdminServer: fkUsuarioAdminVar,
          fkEmpresaServer: fkEmpresaVar
        })
      }).then(function (resposta) {

        console.log("resposta: ", resposta);

        if (resposta.ok) {
          setTimeout(function () {
            window.location = "/painelFuncionarios.html";
          }, 1000);

        } else {
          throw ("Houve um erro ao tentar realizar o cadastro!");
        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);

      });
    }
  }

  function listarFuncionario(idUsuarioLog) {
    var hidden_div = document.getElementById("hidden_form")
    hidden_div.style.display = "block"
    h2_form.innerHTML = "Gerenciar funcionário"

    container_btns.innerHTML = `<button id="btn_atualizacao" onclick="atualizarFuncionario(${idUsuarioLog})">Atualizar</button>`

    fetch(`/usuarios/listarFuncionario/${idUsuarioLog}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    }).then(function (resposta) {
      if (resposta.ok) {
        if (resposta.status == 204) {
          throw "Nenhum resultado encontrado!!";
        }
        resposta.json().then(function (resposta) {

          for (let i = 0; i < resposta.length; i++) {

            var publicacao = resposta[i]; // i é a posição 0
            console.log(publicacao);

            ipt_nomeUsuario.value = publicacao.nomeUser;
            ipt_cargoUsuario.value = publicacao.cargoUser;
            ipt_setorUsuario.value = publicacao.setorUser;
            ipt_cpfUsuario.value = publicacao.cpfUser;
            ipt_emailUsuario.value = publicacao.emailUser;
            (publicacao.userAdmin == null) ? chkAdmin.checked = true : chkAdmin.checked = false

          }
        })
      } else {
        throw ('Houve um erro na API!');
      }
    }).catch(function (resposta) {
      console.error(resposta);
    });
  }

  function atualizarFuncionario(idUsuario) {
    var idUsuarioAdminVar = sessionStorage.getItem('ID_USUARIO')
    var nomeUsuarioVar = ipt_nomeUsuario.value;
    var cargoUsuarioVar = ipt_cargoUsuario.value;
    var setorUsuarioVar = ipt_setorUsuario.value;
    var emailUsuarioVar = ipt_emailUsuario.value;
    var senhaUsuarioVar = ipt_senhaUsuario.value;
    var cpfUsuarioVar = ipt_cpfUsuario.value;
    var fkEmpresaVar = sessionStorage.ID_EMPRESA;
    var fkUsuarioAdminVar = (document.getElementById("chkAdmin").checked) ? 'null' : idUsuarioAdminVar

    if (
      nomeUsuarioVar == "" || cargoUsuarioVar == "" || setorUsuarioVar == "" || emailUsuarioVar == "" || cpfUsuarioVar == "" || fkUsuarioAdminVar == "" || fkEmpresaVar == ""
    ) {
      cardErro.style.display = "block"
      mensagem_erro.innerHTML = "Existem dados em branco"
    } else {

      fetch(`/usuarios/atualizarFuncionario/${idUsuario}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          nomeUsuarioServer: nomeUsuarioVar,
          cargoUsuarioServer: cargoUsuarioVar,
          setorUsuarioServer: setorUsuarioVar,
          emailUsuarioServer: emailUsuarioVar,
          senhaUsuarioServer: senhaUsuarioVar,
          cpfUsuarioServer: cpfUsuarioVar,
          fkUsuarioAdminServer: fkUsuarioAdminVar,
          fkEmpresaServer: fkEmpresaVar,
          idUsuarioServer: idUsuario,
          idUsuarioAdminServer: idUsuarioAdminVar
        })
      }).then(function (resposta) {

        console.log("resposta: ", resposta);

        if (resposta.ok) {
          alert("Atualizado com sucesso!")
          setTimeout(function () {
            window.location = "/painelFuncionarios.html";
          }, 1000);

        } else {
          throw ("Houve um erro ao tentar realizar a atualização!");
        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);

      });
    }
  }

  function cadastrarMaquina(idUsuario){
    var idEmpresaVar = sessionStorage.ID_EMPRESA;
    var idUsuarioVar = idUsuario;

    var marcaMaquinaVar = ipt_marca_maquina.value;
    var modeloMaquinaVar = ipt_modelo_maquina.value;
    var serialNumberMaquinaVar = ipt_serial_number_maquina.value;

    var usoCpuVar = chk_uso_cpu.checked ? "CPU" : null;
    var temperaturaCpu = chk_temperatura_cpu.checked ? "CPU" : null;
    var usoRam = chk_uso_ram.checked ? "RAM" : null;

    fetch("/usuarios/cadastroMaquina", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          idEmpresaServer: idEmpresaVar,
          idUsuarioServer: idUsuarioVar,
          marcaMaquinaServer: marcaMaquinaVar,
          modeloMaquinaServer: modeloMaquinaVar,
          serialNumberMaquinaServer: serialNumberMaquinaVar,
          usoCpuServer: usoCpuVar,
          temperaturaCpuServer: temperaturaCpuVar,
          usoRamServer: usoRamVar
          
        })
      }).then(function (resposta) {

        console.log("resposta: ", resposta);

        if (resposta.ok) {
          setTimeout(function () {
            window.location = "/painelFuncionarios.html";
          }, 1000);

        } else {
          throw ("Houve um erro ao tentar realizar o cadastro!");
        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);

      });
    }

</script>